## 3.`dispatch_semaphore_t`

## ç›®å½•
- ä¸€ã€æ¦‚è¿°
- äºŒã€ä¿¡å·é‡ç›¸å…³çš„3ä¸ªæ–¹æ³•
    - `dispatch_semaphore_create`
    - `dispatch_semaphore_wait`
    - `dispatch_semaphore_signal`
- ä¸‰ã€ä¿¡å·é‡çš„åº”ç”¨
    - 3.1 èµ„æºåŠ é” - é“¶è¡Œå­˜å–æ¬¾æ¡ˆä¾‹
    - 3.2 çº¿ç¨‹åŒæ­¥
        - 3.2.1 å¼‚æ­¥ä»»åŠ¡å®Œæˆåï¼Œå›åˆ°ä¸»çº¿ç¨‹ç»§ç»­å…¶ä»–ä»»åŠ¡
        - 3.2.2 å¼‚æ­¥ä»»åŠ¡è¶…æ—¶

## ä¸€ã€æ¦‚è¿°
æœ¬æ–‡å°†ä»‹ç»GCDå¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ `dispatch_semaphore` ï¼Œå†…å®¹å¦‚ä¸‹ï¼š
* ä¿¡å·é‡çš„åŸºæœ¬æ¦‚å¿µä¸åŸºæœ¬ä½¿ç”¨
* ä¿¡å·é‡åœ¨`çº¿ç¨‹åŒæ­¥`ã€`èµ„æºåŠ é”`æ–¹é¢çš„åº”ç”¨
* ä¿¡å·é‡é‡Šæ”¾æ—¶çš„æ³¨æ„äº‹é¡¹

`dispatch_semaphore` ä¿—ç§°ä¿¡å·é‡ï¼Œä¹Ÿç§°ä¸ºä¿¡å·é”ï¼Œåœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ä¸»è¦ç”¨äºæ§åˆ¶å¤šçº¿ç¨‹ä¸‹è®¿é—®èµ„æºçš„æ•°é‡ï¼Œæ¯”å¦‚ç³»ç»Ÿæœ‰ä¸¤ä¸ªèµ„æºå¯ä»¥ä½¿ç”¨ï¼Œä½†åŒæ—¶æœ‰ä¸‰ä¸ªçº¿ç¨‹è¦è®¿é—®ï¼Œæ‰€ä»¥åªèƒ½å…è®¸ä¸¤ä¸ªçº¿ç¨‹è®¿é—®ï¼Œç¬¬ä¸‰ä¸ªåº”å½“ç­‰å¾…èµ„æºè¢«é‡Šæ”¾åå†è®¿é—®ï¼Œè¿™æ—¶æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ `dispatch_semaphore`ã€‚

ä¸ `dispatch_semaphore` ç›¸å…³çš„å…±æœ‰3ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯`dispatch_semaphore_create`, `dispatch_semaphore_wait`, `dispatch_semaphore_signal` ä¸‹é¢æˆ‘ä»¬é€ä¸€äº†è§£ä¸€ä¸‹è¿™ä¸‰ä¸ªæ–¹æ³•ã€‚

## äºŒã€ä¿¡å·é‡ç›¸å…³çš„3ä¸ªæ–¹æ³•

### 2.1 `dispatch_semaphore_create`


```objc
/*!
 * @function dispatch_semaphore_create
 *
 * @abstract ä½¿ç”¨åˆå§‹å€¼åˆ›å»ºæ–°çš„è®¡æ•°ä¿¡å·é‡ã€‚
 *
 * @discussion
 *      â‘ å½“ä¸¤ä¸ªçº¿ç¨‹éœ€è¦åè°ƒæŸä¸ªç‰¹å®šäº‹ä»¶çš„å®Œæˆæ—¶ï¼Œä¼ é€’å€¼ä¸º0æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚
 *      â‘¡ä¼ é€’å¤§äº0çš„å€¼å¯¹äºç®¡ç†æœ‰é™çš„èµ„æºæ± å¾ˆæœ‰ç”¨ï¼Œå…¶ä¸­æ± å¤§å°ç­‰äºè¯¥å€¼ã€‚
 *
 * @param value ä¿¡å·é‡çš„èµ·å§‹å€¼ã€‚ä¼ é€’ä¸€ä¸ªå°äºé›¶çš„å€¼å°†å¯¼è‡´è¿”å›NULLã€‚
 *
 * @result æ–°åˆ›å»ºçš„ä¿¡å·é‡ï¼Œå¤±è´¥æ—¶ä¸ºNULLã€‚
 */
dispatch_semaphore_t dispatch_semaphore_create(intptr_t value);
```

æ ¹æ®è‹¹æœæä¾›çš„æ–‡æ¡£æˆ‘ä»¬å¯ä»¥å¾—åˆ°çš„ä¿¡æ¯æœ‰ï¼š
å¯¹äºä¿¡å·é‡çš„åˆå§‹å€¼ï¼Œæœ‰2ç§æƒ…å†µï¼ˆå¯¹åº”2ç§åº”ç”¨åœºæ™¯ï¼‰ï¼š
1. çº¿ç¨‹åŒæ­¥ï¼šä¿¡å·é‡åˆå§‹å€¼ç­‰äº0ï¼Œè¿™ç§æƒ…å†µä¸»è¦ç”¨äºä¸¤ä¸ªçº¿ç¨‹éœ€è¦åè°ƒç‰¹å®šäº‹ä»¶çš„å®Œæˆæ—¶ï¼Œå³çº¿ç¨‹åŒæ­¥
2. èµ„æºé”ğŸ”ï¼šä¿¡å·é‡åˆå§‹å€¼å¤§äº0ï¼Œè¿™ç§æƒ…å†µä¸»è¦ç”¨äºç®¡ç†æœ‰é™çš„èµ„æºæ± ï¼Œå…¶ä¸­æ± å¤§å°ç­‰äºè¿™ä¸ªå€¼ï¼Œå³èµ„æºåŠ é”ã€‚

### 2.2 `dispatch_semaphore_wait`

```objc
/*!
 * @function dispatch_semaphore_wait
 *
 * @abstract ç­‰å¾…(é€’å‡)ä¸€ä¸ªä¿¡å·é‡ã€‚
 *
 * @discussion å‡å°‘è®¡æ•°ä¿¡å·é‡ã€‚å¦‚æœç»“æœå€¼å°äºé›¶ï¼Œåˆ™è¯¥å‡½æ•°ç­‰å¾…ä¿¡å·å‡ºç°åæ‰è¿”å›ã€‚
 *
 * @param dsema ä¿¡å·é‡ã€‚åœ¨è¿™ä¸ªå‚æ•°ä¸­ä¼ é€’NULLçš„ç»“æœæ˜¯æœªå®šä¹‰çš„ã€‚
 *
 * @param timeout ä½•æ—¶è¶…æ—¶(å‚è§dispatch_time)ã€‚ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œè¿™é‡Œæœ‰DISPATCH_TIME_NOWå’ŒDISPATCH_TIME_FOREVERå¸¸æ•°ã€‚
 *
 * @result æˆåŠŸæ—¶è¿”å›é›¶ï¼Œå¦‚æœå‘ç”Ÿè¶…æ—¶åˆ™è¿”å›éé›¶ã€‚
 */
intptr_t dispatch_semaphore_wait(dispatch_semaphore_t dsema, dispatch_time_t timeout);
```

`dispatch_semaphore_wait` è¿™ä¸ªæ–¹æ³•ç”¨äºç­‰å¾…æˆ–å‡å°‘ä¿¡å·é‡ï¼Œæ¯æ¬¡è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œä¿¡å·é‡çš„å€¼éƒ½ä¼šå‡ä¸€ï¼Œç„¶åæ ¹æ®å‡ä¸€åçš„ä¿¡å·é‡çš„å€¼çš„å¤§å°ï¼Œæ¥å†³å®šè¿™ä¸ªæ–¹æ³•çš„ä½¿ç”¨æƒ…å†µï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•çš„ä½¿ç”¨åŒæ ·ä¹Ÿåˆ†ä¸º2ç§æƒ…å†µï¼š
1. å½“å‡ä¸€åçš„å€¼å°äº0æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šä¸€ç›´ç­‰å¾…ï¼Œå³é˜»å¡å½“å‰çº¿ç¨‹ï¼Œå”¤é†’æ¡ä»¶æ˜¯ï¼šä¿¡å·é‡`+1`æˆ–è€…`ç›´åˆ°è¶…æ—¶`ã€‚
2. å½“å‡ä¸€åçš„å€¼å¤§äºæˆ–ç­‰äº0æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šç›´æ¥è¿”å›ï¼Œä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ã€‚

ä¸Šè¿°2ç§æ–¹å¼ï¼Œå¯¹åº”æˆ‘ä»¬æ—¥å¸¸çš„å¼€å‘ä¸­å°±æ˜¯ä¸‹é¢2ç§ä½¿ç”¨æƒ…å†µï¼š
1. å½“æˆ‘ä»¬åªéœ€è¦åŒæ­¥çº¿ç¨‹æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `dispatch_semaphore_create(0)` åˆå§‹åŒ–ä¿¡å·é‡ä¸º0ï¼Œç„¶åä½¿ç”¨ `dispatch_semaphore_wait` æ–¹æ³•è®©ä¿¡å·é‡å‡ä¸€ï¼Œè¿™æ—¶å°±å±äºç¬¬ä¸€ç§å‡ä¸€åå°äº0çš„æƒ…å†µï¼Œè¿™æ—¶å°±ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ `dispatch_semaphore_signal` è¿™ä¸ªè®©ä¿¡å·é‡åŠ 1çš„æ–¹æ³•åï¼Œå½“å‰çº¿ç¨‹æ‰ä¼šè¢«å”¤é†’ï¼Œç„¶åæ‰§è¡Œå½“å‰çº¿ç¨‹ä¸­çš„ä»£ç ï¼Œè¿™æ—¶å°±èµ·åˆ°ä¸€ä¸ªçº¿ç¨‹åŒæ­¥çš„ä½œç”¨ã€‚
2. å½“æˆ‘ä»¬éœ€è¦å¯¹èµ„æºåŠ é”ï¼Œæ§åˆ¶åŒæ—¶èƒ½è®¿é—®èµ„æºçš„æœ€å¤§æ•°é‡ï¼ˆå‡è®¾ä¸ºnï¼‰æ—¶ï¼Œæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨`dispatch_semaphore_create(n)` æ–¹æ³•æ¥åˆå§‹åŒ–ä¿¡å·é‡ä¸ºnï¼Œç„¶åä½¿ç”¨`dispatch_semaphore_wait` æ–¹æ³•å°†ä¿¡å·é‡å‡ä¸€ï¼Œç„¶åè®¿é—®æˆ‘ä»¬çš„èµ„æºï¼Œç„¶åä½¿ç”¨`dispatch_semaphore_signal` æ–¹æ³•å°†ä¿¡å·é‡åŠ ä¸€ã€‚å¦‚æœæœ‰nä¸ªçº¿ç¨‹æ¥è®¿é—®è¿™ä¸ªèµ„æºï¼Œå½“è¿™nä¸ªèµ„æºè®¿é—®éƒ½è¿˜æ²¡æœ‰ç»“æŸæ—¶ï¼Œå°±ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç¬¬n+1ä¸ªçº¿ç¨‹çš„è®¿é—®å°±å¿…é¡»ç­‰å¾…ï¼Œç›´åˆ°å‰nä¸ªçš„æŸä¸€ä¸ªçš„èµ„æºè®¿é—®ç»“æŸï¼Œè¿™å°±æ˜¯æˆ‘ä»¬å¾ˆå¸¸è§çš„èµ„æºåŠ é”çš„æƒ…å†µã€‚


### 2.3 `dispatch_semaphore_signal`

```objc
/*!
 * @function dispatch_semaphore_signal
 *
 * @abstract å‘é€(å¢åŠ )ä¸€ä¸ªä¿¡å·é‡ã€‚
 *
 * @discussion å¢åŠ è®¡æ•°ä¿¡å·é‡ã€‚å¦‚æœä¹‹å‰çš„å€¼å°äºé›¶ï¼Œä¼šå”¤é†’ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹ã€‚
 *
 * @param dsema è®¡æ•°ä¿¡å·é‡ã€‚åœ¨è¿™ä¸ªå‚æ•°ä¸­ä¼ é€’NULLçš„ç»“æœæ˜¯æœªå®šä¹‰çš„ã€‚
 *
 * @result å¦‚æœçº¿ç¨‹è¢«å”¤é†’ï¼Œè¿™ä¸ªå‡½æ•°è¿”å›éé›¶å€¼ã€‚å¦åˆ™ï¼Œè¿”å›0ã€‚
 */
intptr_t dispatch_semaphore_signal(dispatch_semaphore_t dsema);
```

`dispatch_semaphore_signal` æ–¹æ³•ç”¨äºè®©ä¿¡å·é‡çš„å€¼åŠ ä¸€ï¼Œç„¶åç›´æ¥è¿”å›ã€‚å¦‚æœå…ˆå‰ä¿¡å·é‡çš„å€¼å°äº0ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•è¿˜ä¼šå”¤é†’å…ˆå‰ç­‰å¾…çš„çº¿ç¨‹ã€‚

## ä¸‰ã€ä¿¡å·é‡çš„åº”ç”¨

### 3.1 èµ„æºåŠ é”

é“¶è¡Œå­˜å–æ¬¾æ¡ˆä¾‹ï¼š
> å‡è®¾æˆ‘ä»¬è´¦å·é‡Œé¢æœ‰100å…ƒï¼Œæ¯æ¬¡å­˜é’±éƒ½å­˜10å…ƒï¼Œæ¯æ¬¡å–é’±éƒ½å–20å…ƒã€‚å­˜5æ¬¡ï¼Œå–5æ¬¡ã€‚é‚£ä¹ˆå°±æ˜¯åº”è¯¥æœ€ç»ˆå‰©ä¸‹50å…ƒæ‰å¯¹ã€‚å¦‚æœæˆ‘ä»¬æŠŠå­˜å’Œå–é’±åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­è®¿é—®çš„æ—¶å€™ï¼Œå¦‚æœä¸åŠ é”ï¼Œå°±å¾ˆå¯èƒ½å¯¼è‡´é—®é¢˜ã€‚

#### âŒé”™è¯¯çš„ä»£ç  - ä¸åŠ é”

åˆ›å»ºä¸€ä¸ªè´¦æˆ·ç±» `TKAccount`ï¼Œä¸“é—¨ç”¨äºå¤„ç†å­˜ã€å–é’±æ“ä½œã€‚

.hæ–‡ä»¶ï¼š
```objc
NS_ASSUME_NONNULL_BEGIN

@interface TKAccount : NSObject

/// å­˜é’±ã€å–é’±æ¼”ç¤º
- (void)moneyTest;

/// å­˜é’±
- (void)saveMoney;

/// å–é’±
- (void)drawMoney;

@end

NS_ASSUME_NONNULL_END
```

.mæ–‡ä»¶
```objc
#import "TKAccount.h"

@interface TKAccount ()
@property (nonatomic, assign) int money;
@end

@implementation TKAccount

// å­˜é’±ã€å–é’±æ¼”ç¤º
- (void)moneyTest {
    self.money = 100;
    
    /*
     å­˜ä¸å–é’±ï¼Œå…è®¸åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­åŒæ—¶æ“ä½œï¼Œæœ€ç»ˆç»“æœä¼šå¯¼è‡´ç”¨æˆ·çš„è´¦æˆ·ä½™é¢ä¸æ˜¯ 50å…ƒã€‚
     */
    
    dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
    
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
            [self saveMoney];
        }
    });
    
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
            [self drawMoney];
        }
    });
}

// å­˜é’±
- (void)saveMoney {
    int oldMoney = self.money;
    sleep(.2);
    oldMoney += 10;
    self.money = oldMoney;
    
    NSLog(@"å­˜10å…ƒï¼Œè¿˜å‰©%då…ƒ - %@", oldMoney, [NSThread currentThread]);
}

// å–é’±
- (void)drawMoney {
    int oldMoney = self.money;
    sleep(.2);
    oldMoney -= 20;
    self.money = oldMoney;
    
    NSLog(@"å–20å…ƒï¼Œè¿˜å‰©%då…ƒ - %@", oldMoney, [NSThread currentThread]);
}

@end
```

å¼€å§‹æµ‹è¯•ï¼š
```objc
- (void)test {
    TKAccount *account = [TKAccount new];
    [account moneyTest];
}
```

è¾“å…¥æ—¥å¿—ï¼š
```
 2021-06-16 14:31:00.121599+0800 iOSDemo[25424:243607] å–20å…ƒï¼Œè¿˜å‰©80å…ƒ - <NSThread: 0x6000007a6140>{number = 13, name = (null)}
 2021-06-16 14:31:00.121599+0800 iOSDemo[25424:243549] å­˜10å…ƒï¼Œè¿˜å‰©110å…ƒ - <NSThread: 0x60000079ef40>{number = 12, name = (null)}
 2021-06-16 14:31:00.121742+0800 iOSDemo[25424:243607] å–20å…ƒï¼Œè¿˜å‰©60å…ƒ - <NSThread: 0x6000007a6140>{number = 13, name = (null)}
 2021-06-16 14:31:00.121748+0800 iOSDemo[25424:243549] å­˜10å…ƒï¼Œè¿˜å‰©70å…ƒ - <NSThread: 0x60000079ef40>{number = 12, name = (null)}
 2021-06-16 14:31:00.121989+0800 iOSDemo[25424:243607] å–20å…ƒï¼Œè¿˜å‰©50å…ƒ - <NSThread: 0x6000007a6140>{number = 13, name = (null)}
 2021-06-16 14:31:00.122356+0800 iOSDemo[25424:243549] å­˜10å…ƒï¼Œè¿˜å‰©60å…ƒ - <NSThread: 0x60000079ef40>{number = 12, name = (null)}
 2021-06-16 14:31:00.122600+0800 iOSDemo[25424:243607] å–20å…ƒï¼Œè¿˜å‰©40å…ƒ - <NSThread: 0x6000007a6140>{number = 13, name = (null)}
 2021-06-16 14:31:00.122811+0800 iOSDemo[25424:243549] å­˜10å…ƒï¼Œè¿˜å‰©50å…ƒ - <NSThread: 0x60000079ef40>{number = 12, name = (null)}
 2021-06-16 14:31:00.122941+0800 iOSDemo[25424:243607] å–20å…ƒï¼Œè¿˜å‰©30å…ƒ - <NSThread: 0x6000007a6140>{number = 13, name = (null)}
 2021-06-16 14:31:00.123187+0800 iOSDemo[25424:243549] å­˜10å…ƒï¼Œè¿˜å‰©40å…ƒ - <NSThread: 0x60000079ef40>{number = 12, name = (null)}
```

åˆ†æï¼š
å¯ä»¥çœ‹åˆ°ï¼Œç”¨æˆ·ä½™é¢å¹¶ä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„å€¼ã€‚
åŸå› æ˜¯ï¼šä¸åŒçº¿ç¨‹æ‰§è¡Œå­˜å–é’±æ“ä½œï¼Œå¯¼è‡´å‡ºç°äº†è„æ•°æ®ã€‚
è§£å†³åŠæ³•ï¼šå¯¹è´¦æˆ·åŠ é”å¤„ç†ï¼Œä¸å…è®¸è¯»å†™åŒæ—¶æ“ä½œï¼šå½“å­˜é’±æ—¶ï¼Œä¸å…è®¸å–é’±ï¼›åä¹‹äº¦ç„¶ã€‚

**æ€»ç»“ï¼š**ä¿¡å·é‡åˆå§‹å€¼ï¼Œå°±æ˜¯åŒæ—¶è®¿é—®èµ„æºæ± çš„çº¿ç¨‹æ•°é‡ã€‚

#### âœ…æ­£ç¡®çš„ä»£ç ï¼š

åˆ›å»ºä¸€ä¸ªå®‰å…¨è´¦æˆ·ç±» `TKSafeAccount`ï¼Œç»§æ‰¿äº `TKAccount`ï¼Œå­˜ã€å–é’±æ—¶ï¼Œå¯¹è´¦æˆ·åŠ é”å¤„ç†ï¼š

.mæ–‡ä»¶ï¼š
```objc
#import "TKSafeAccount.h"

@interface TKSafeAccount ()

@property (nonatomic, strong) dispatch_semaphore_t smp;

@end

@implementation TKSafeAccount

- (instancetype)init {
    self = [super init];
    if (self) {
        // è®¾ç½®åˆå§‹ä¿¡å·é‡è®¡æ•°ä¸º1ï¼ˆæœ€å¤§å¹¶å‘æ•°ä¸º1ï¼‰
        _smp = dispatch_semaphore_create(1);
    }
    return self;
}

- (void)saveMoney {
    dispatch_semaphore_wait(_smp, DISPATCH_TIME_FOREVER);
    [super saveMoney];
    dispatch_semaphore_signal(_smp);
}

- (void)drawMoney {
    dispatch_semaphore_wait(_smp, DISPATCH_TIME_FOREVER);
    [super drawMoney];
    dispatch_semaphore_signal(_smp);
}

@end
```

å¼€å§‹æµ‹è¯•ï¼š
```objc
- (void)test {
    TKSafeAccount *safeA = [[TKSafeAccount alloc] init];
    [safeA moneyTest];
}
```

è¾“å…¥æ—¥å¿—ï¼š
```
2021-06-16 14:43:49.010013+0800 iOSDemo[26755:253446] å–20å…ƒï¼Œè¿˜å‰©80å…ƒ - <NSThread: 0x6000010ccc80>{number = 9, name = (null)}
 2021-06-16 14:43:49.010189+0800 iOSDemo[26755:253786] å­˜10å…ƒï¼Œè¿˜å‰©90å…ƒ - <NSThread: 0x6000010cd6c0>{number = 10, name = (null)}
 2021-06-16 14:43:49.010342+0800 iOSDemo[26755:253446] å–20å…ƒï¼Œè¿˜å‰©70å…ƒ - <NSThread: 0x6000010ccc80>{number = 9, name = (null)}
 2021-06-16 14:43:49.010604+0800 iOSDemo[26755:253786] å­˜10å…ƒï¼Œè¿˜å‰©80å…ƒ - <NSThread: 0x6000010cd6c0>{number = 10, name = (null)}
 2021-06-16 14:43:49.010880+0800 iOSDemo[26755:253446] å–20å…ƒï¼Œè¿˜å‰©60å…ƒ - <NSThread: 0x6000010ccc80>{number = 9, name = (null)}
 2021-06-16 14:43:49.011202+0800 iOSDemo[26755:253786] å­˜10å…ƒï¼Œè¿˜å‰©70å…ƒ - <NSThread: 0x6000010cd6c0>{number = 10, name = (null)}
 2021-06-16 14:43:49.011674+0800 iOSDemo[26755:253446] å–20å…ƒï¼Œè¿˜å‰©50å…ƒ - <NSThread: 0x6000010ccc80>{number = 9, name = (null)}
 2021-06-16 14:43:49.011963+0800 iOSDemo[26755:253786] å­˜10å…ƒï¼Œè¿˜å‰©60å…ƒ - <NSThread: 0x6000010cd6c0>{number = 10, name = (null)}
 2021-06-16 14:43:49.012407+0800 iOSDemo[26755:253446] å–20å…ƒï¼Œè¿˜å‰©40å…ƒ - <NSThread: 0x6000010ccc80>{number = 9, name = (null)}
 2021-06-16 14:43:49.012782+0800 iOSDemo[26755:253786] å­˜10å…ƒï¼Œè¿˜å‰©50å…ƒ - <NSThread: 0x6000010cd6c0>{number = 10, name = (null)}
```

å¯ä»¥çœ‹åˆ°ï¼Œæœ€ç»ˆç»“æœå°±æ˜¯æˆ‘ä»¬æœŸæœ›çš„å€¼ã€‚
åˆ†æï¼š-moneyTestï¼Œé’ˆå¯¹å­˜ã€å–æ“ä½œåŠ äº†çº¿ç¨‹é”ï¼Œè¿™æ ·å°±ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚æœ€ç»ˆè¾¾åˆ°äº†é¢„æœŸæ•ˆæœ

### 3.2 çº¿ç¨‹åŒæ­¥

#### 3.2.1 å¼‚æ­¥ä»»åŠ¡å®Œæˆåï¼Œå›åˆ°ä¸»çº¿ç¨‹ç»§ç»­å…¶ä»–ä»»åŠ¡

è¿™ç§åœºæ™¯å¾ˆå¸¸è§ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªå¼‚æ­¥ç½‘ç»œä»»åŠ¡ï¼Œå¼€å‘è€…éœ€è¦åœ¨è·å–åˆ°ç½‘ç»œæ•°æ®åå›åˆ°ä¸»çº¿ç¨‹åˆ·æ–°é¡µé¢ã€‚
æµ‹è¯•ä»£ç ï¼š
```objc
- (void)test {
    
    NSLog(@"---1---");
    
    // çº¿ç¨‹åŒæ­¥
    dispatch_semaphore_t sema = dispatch_semaphore_create(0);
    
    [self asynHandler:^ { // å¼‚æ­¥è°ƒç”¨ï¼Œè§£é™¤é˜»å¡çš„çº¿ç¨‹
        NSLog(@"---2---");
        
        dispatch_semaphore_signal(sema);
    }];
    
    NSLog(@"---3---");
    
    dispatch_semaphore_wait(sema, DISPATCH_TIME_FOREVER);
    
    NSLog(@"---4-åˆ·æ–°é¡µé¢--");
}

// å¼‚æ­¥è°ƒç”¨ï¼Œæ¨¡æ‹Ÿè€—æ—¶ä»»åŠ¡
- (void)asynHandler:(void(^)(void))handler {
    dispatch_async(dispatch_queue_create("com.tank", 0), ^{
        sleep(2);
        !handler ?: handler();
    });
}
```

è¾“å‡ºæ—¥å¿—ï¼š
```
2021-12-03 13:47:53.465354+0800 fps_demo[13210:175661] ---1---
2021-12-03 13:47:53.465814+0800 fps_demo[13210:175661] ---3---
2021-12-03 13:47:55.499237+0800 fps_demo[13210:176083] ---2---
2021-12-03 13:47:55.499505+0800 fps_demo[13210:175661] ---4-åˆ·æ–°é¡µé¢--
```

åˆ†æï¼š
ä»ä»£ç æ‰§è¡Œé¡ºåºæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œ`dispatch_semaphore_wait` ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œç›´åˆ°å¼‚æ­¥ä»»åŠ¡å®Œæˆè°ƒç”¨ `dispatch_semaphore_signal` åï¼Œæ‰ä¼šæ‰§è¡Œä¸»çº¿ç¨‹åç»­çš„ä»»åŠ¡ã€‚

#### 3.2.2 å¼‚æ­¥ä»»åŠ¡è¶…æ—¶

ä¿®æ”¹æ¡ˆä¾‹ `3.2.1` çš„ä¸€è¡Œä»£ç ï¼Œå°† `dispatch_semaphore_wait` è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º2ç§’ï¼Œå³ `dispatch_time(DISPATCH_TIME_NOW, 1 * NSEC_PER_SEC)`ã€‚å…¶ä»–ä»£ç ä¸å˜ã€‚

```objc
// è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º 2ç§’
dispatch_semaphore_wait(sema, dispatch_time(DISPATCH_TIME_NOW, 1 * NSEC_PER_SEC));
```

è¾“å‡ºæ—¥å¿—ï¼š
```
2021-12-03 13:57:11.254787+0800 fps_demo[13760:185128] ---1---
2021-12-03 13:57:11.254929+0800 fps_demo[13760:185128] ---3---
2021-12-03 13:57:12.255222+0800 fps_demo[13760:185128] ---4-åˆ·æ–°é¡µé¢--
2021-12-03 13:57:13.258995+0800 fps_demo[13760:185336] ---2---
```

åˆ†æï¼š
å¯ä»¥çœ‹å‡ºï¼Œä»»åŠ¡çš„æ‰§è¡Œé¡ºåºå‘ç”Ÿäº†å˜åŒ–ï¼šå› ä¸º wait è®¾ç½®çš„è¶…æ—¶æ—¶é—´æ˜¯1ç§’ï¼Œå½“ wait è¾¾åˆ°1ç§’æ—¶ï¼Œå³ä½¿ç½‘ç»œä»»åŠ¡å°šæœªå®Œæˆï¼Œæ­¤æ—¶ä¿¡å·é‡ä¹Ÿä¼šåŠ 1ï¼Œä¸åœ¨é˜»å¡ä¸»çº¿ç¨‹ï¼Œç»§ç»­æ‰§è¡Œä¸»çº¿ç¨‹åç»­ä»»åŠ¡ã€‚
