## <center> `NSTimer` 和 `CADisplayLink` 存在的问题


不准时：NSTime和CADisplayLink底层都是基于RunLoop的CFRunLoopTimerRef的实现的，也就是说它们都依赖于RunLoop。如果RunLoop的任务过于繁重，会导致它们不准时。

比如NSTimer每1.0秒就会执行一次任务，Runloop每进行一次循环，就会看一下NSTimer的时间是否达到1.0秒，是的话就执行任务。但是由于Runloop每一次循环的任务不一样，所花费的时间就不固定。假设第一次循环所花时间为 0.2s，第二次 0.3s，第三次 0.3s，则再过 0.2s 就会执行NSTimer的任务，这时候可能Runloop的任务过于繁重，第四次花了0.5s，那加起来时间就是 1.3s，导致NSTimer不准时。
解决方法：使用 GCD 的定时器。GCD 的定时器是直接跟系统内核挂钩的，而且它不依赖于RunLoop，所以它非常的准时。示例如下：

```
/// 定义属性
@property (nonatomic, strong) dispatch_source_t timer;    
```

创建 `dispatch_source_t`：
```
dispatch_queue_t queue = dispatch_queue_create("com.timer.queue", DISPATCH_QUEUE_SERIAL);

// 创建定时器
dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, queue);
// 设置时间
uint64_t start = 2.0;    // 几秒后开始执行
uint64_t interval = 1.0; // 时间间隔，单位：秒
dispatch_source_set_timer(timer, dispatch_time(DISPATCH_TIME_NOW, start * NSEC_PER_SEC), interval * NSEC_PER_SEC, 0);
// 设置回调
dispatch_source_set_event_handler(timer, ^{
    NSLog(@"%@", [NSThread currentThread]);
});
// 启动定时器
dispatch_resume(timer);
_timer = timer;

NSLog(@"%@",[NSThread currentThread]);
```

输出日志：
```
2021-11-23 16:23:15.912577+0800 runloop_timer <_NSMainThread: 0x600001278440>{number = 1, name = main}
2021-11-23 16:23:17.912899+0800 runloop_timer <NSThread: 0x600001273e00>{number = 6, name = (null)}
2021-11-23 16:23:18.912949+0800 runloop_timer <NSThread: 0x60000122fa00>{number = 7, name = (null)}
2021-11-23 16:23:19.912861+0800 runloop_timer <NSThread: 0x600001273e00>{number = 6, name = (null)}
2021-11-23 16:23:20.912924+0800 runloop_timer <NSThread: 0x600001234600>{number = 2, name = (null)}
2021-11-23 16:23:21.913636+0800 runloop_timer <NSThread: 0x600001234600>{number = 2, name = (null)}
2021-11-23 16:23:22.913040+0800 runloop_timer <NSThread: 0x60000122fa00>{number = 7, name = (null)}
2021-11-23 16:23:23.912888+0800 runloop_timer <NSThread: 0x600001234600>{number = 2, name = (null)}
2021-11-23 16:23:24.913013+0800 runloop_timer <NSThread: 0x60000122fa00>{number = 7, name = (null)}
2021-11-23 16:23:25.913309+0800 runloop_timer <NSThread: 0x600001234600>{number = 2, name = (null)}
2021-11-23 16:23:26.913668+0800 runloop_timer <NSThread: 0x60000122fa00>{number = 7, name = (null)}
```
