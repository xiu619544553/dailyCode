## <center> 苹果官方关于 `RunLoop` 的描述

### 目录
- 一、概述
- 二、解剖 `RunLoop`
    - 1、Run Loop Modes

### 一、概述
苹果官方关于 RunLoop 的描述：[传送门](https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html#//apple_ref/doc/uid/10000057i-CH16-SW23)

运行循环是与线程相关联的基本基础结构的一部分。运行循环是用于调度工作和协调接收传入事件的事件处理循环。运行循环的目的是在有工作要做时让线程保持忙碌，在没有工作时让线程进入睡眠状态。

运行循环管理不是完全自动的。开发者仍然必须设计线程的代码，以在适当的时间启动运行循环并响应传入的事件。Cocoa和Core Foundation都提供了运行循环对象来帮助开发者配置和管理线程的运行循环。你的应用程序不需要显式地创建这些对象;每个线程，包括应用程序的主线程，都有一个相关联的运行循环对象。然而，只有次要线程需要显式地运行它们的运行循环。作为应用程序启动过程的一部分，应用程序框架会在主线程上自动设置并运行run循环。

下面几节提供更多关于运行循环的信息，以及如何为应用程序配置它们。有关运行循环对象的更多信息，请参见  [NSRunLoop](https://developer.apple.com/documentation/foundation/nsrunloop) 类引用和 [CFRunLoop](https://developer.apple.com/documentation/corefoundation/cfrunloop) 引用。

### 二、解剖 `RunLoop`

运行循环非常像它的名字。它是线程进入的循环，用于运行事件处理程序来响应传入的事件。您的代码提供了用于实现运行循环的实际循环部分的控制语句，换句话说，您的代码提供了驱动运行循环的while或for循环。在循环中，使用run loop对象“运行接收事件并调用已安装的处理程序的事件处理代码”。

运行循环从两种不同类型的源接收事件。输入源传递异步事件，通常是来自另一个线程或不同应用程序的消息。计时器源交付同步事件，这些事件以预定的时间或重复的间隔发生。这两种类型的源都使用特定于应用程序的处理程序例程在事件到达时处理事件。

图3-1显示了运行循环和各种源的概念结构。输入源将异步事件传递给相应的处理程序，并导致runUntilDate:方法(在线程关联的NSRunLoop对象上调用)退出。计时器源将事件传递给它们的处理程序例程，但不会导致运行循环退出。

图3-1运行循环的结构和源
![图3-1](https://github.com/xiu619544553/dailyCode/blob/master/icons/apple_3_1运行循环的结构和源.png)

除了处理输入源外，运行循环还生成关于运行循环行为的通知。注册的运行循环观察者可以接收这些通知，并使用它们在线程上做额外的处理。使用Core Foundation在线程上安装运行循环观察器。

以下部分提供了关于运行循环的组件及其运行模式的更多信息。它们还描述了在处理事件的不同时间生成的通知。

#### 1、Run Loop Modes

运行循环模式是要监视的输入源和计时器的集合，以及要通知的运行循环观察器的集合。每次运行运行循环时，都指定(显式或隐式)要运行的特定模式。在运行循环的过程中，只有与该模式关联的源被监视并允许交付它们的事件。(类似地，只有与该模式关联的观察者才会被通知运行循环的进度。)与其他模式关联的源会保留任何新事件，直到后续事件以适当的模式通过循环。

在代码中，通过名称识别模式。Cocoa和Core Foundation都定义了默认模式和一些常用模式，以及用于在代码中指定这些模式的字符串。只需为模式名指定一个自定义字符串，就可以定义自定义模式。虽然您为自定义模式分配的名称是任意的，但这些模式的内容不是。您必须确保将一个或多个输入源、计时器或运行循环观察器添加到您为它们创建的任何模式中，以使它们有用。

在运行循环的特定过程中，使用模式过滤掉来自不需要的源的事件。大多数时候，您希望在系统定义的默认模式下运行运行循环。然而，模态面板可以在模态模式下运行。在此模式下，只有与模式面板相关的源才会向线程交付事件。对于辅助线程，您可以使用自定义模式来防止低优先级源在时间关键型操作期间传递事件。

**注意**：模式的区别是基于事件的来源，而不是事件的类型。例如，你不会只使用模式来匹配鼠标按下事件或键盘事件。您可以使用模式来侦听一组不同的端口、临时挂起计时器，或者以其他方式更改源并运行当前正在监视的循环观察器。

表3-1列出了Cocoa和Core Foundation定义的标准模式以及使用该模式时的描述。名称列列出了用于在代码中指定模式的实际常量。

表3-1预定义的运行循环模式

| 模式 | 名称 | 描述 |
| --- | --- | --- |
| Default | `NSDefaultRunLoopMode` (Cocoa)、`kCFRunLoopDefaultMode` (Core Foundation) | 默认模式是用于大多数操作的模式。大多数时候，您应该使用此模式来启动运行循环并配置输入源。 |
| Connection | `NSConnectionReplyMode` (Cocoa) | Cocoa将这种模式与NSConnection对象一起使用来监视响应。您自己应该很少需要使用这个模式。 |
| Modal | NSModalPanelRunLoopMode (Cocoa) | Cocoa使用这个模式来识别为模态面板准备的事件。 |
| Event tracking | `NSEventTrackingRunLoopMode` (Cocoa) | Cocoa使用此模式在鼠标拖动循环和其他类型的用户界面跟踪循环期间限制传入事件。 |
| Common modes | `NSRunLoopCommonModes` (Cocoa)、`kCFRunLoopCommonModes` (Core Foundation) | 这是一组可配置的常用模式。将输入源与此模式关联，也将其与组中的每个模式关联。对于Cocoa应用程序，该集合默认包括默认模式、模式和事件跟踪模式。Core Foundation最初只包含默认模式。您可以使用CFRunLoopAddCommonMode函数向集合添加自定义模式。 |